<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Piastrelle numeriche – somma delle frazioni (fix aggiornamento)</title>
<style>
  :root{
    --bg:#f6f7fb; --ink:#1f2330; --muted:#e7e8ee; --panel:#ffffff; --grid:#d8dbe6;
    --ok:#2e7d32; --danger:#b00020; --stroke:#283042;
    --c1:#5a9bd5; --c2:#70ad47; --c3:#ed7d31; --c4:#a64d79; --c5:#ffd966;
    --c6:#4472c4; --c7:#c00000; --c8:#00b0f0; --c9:#92d050; --c10:#7030a0;
    --tileSize:48px;
  }
  html,body{height:100%}
  body{margin:0; font:16px/1.28 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg)}
  header{padding:12px 16px; background:linear-gradient(180deg,#fdfdff,#f4f6fb); border-bottom:1px solid var(--muted)}
  header h1{font-size:1.05rem; margin:0 0 4px}
  header p{margin:0; color:#565a66}

  .wrap{display:grid; grid-template-columns:340px 1fr 320px; gap:12px; padding:12px; height:calc(100vh - 72px)}
  .panel{background:var(--panel); border:1px solid var(--muted); border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.03)}

  #tools .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
  #tools input[type="number"]{width:90px; padding:6px 8px; border:1px solid var(--muted); border-radius:8px}
  #tools button{padding:8px 10px; border-radius:10px; border:1px solid var(--muted); background:#fafbff; cursor:pointer}
  #tools .danger{border-color:#f1c0c4; background:#fff5f6; color:#7a0010}
  #tools .ok{border-color:#cfe6cf; background:#f4fbf4; color:#174d18}
  .seg{display:inline-flex; border:1px solid var(--muted); border-radius:10px; overflow:hidden}
  .seg label{padding:6px 10px; cursor:pointer; background:#fff; border-right:1px solid var(--muted)}
  .seg label:last-child{border-right:none}
  .seg input{display:none}
  .seg input:checked + span{background:#eaf1ff}

  #palette{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .pItem{background:#fff; border:1px dashed var(--muted); border-radius:12px; padding:8px; display:flex; flex-direction:column; align-items:center; gap:6px}
  .numPreview{display:flex; align-items:center; justify-content:center; width:120px; height:56px; border-radius:10px; border:1px solid var(--muted); font-weight:800; font-size:1.2rem; color:#111}
  .act{padding:6px 10px; border-radius:8px; border:1px solid var(--muted); background:#fff; cursor:pointer}

  #workspace{
    position:relative; overflow:auto; height:100%;
    background:
      linear-gradient(90deg,transparent calc(var(--tileSize) - 1px), var(--grid) 1px),
      linear-gradient(transparent calc(var(--tileSize) - 1px), var(--grid) 1px);
    background-size: var(--tileSize) var(--tileSize);
    border:1px solid var(--muted); border-radius:12px;
  }

  .item{position:absolute; cursor:grab; touch-action:none}
  .badge{position:absolute; top:-10px; right:-10px; font-size:.8rem; background:#fff; border:1px solid var(--muted); padding:2px 6px; border-radius:999px}
  .rotBtn{
    position:absolute; left:-12px; top:-12px; width:24px; height:24px; border-radius:50%;
    background:#fff; border:1px solid var(--muted); display:flex; align-items:center; justify-content:center;
    font-size:.85rem; cursor:pointer; user-select:none;
  }
  .labelNum{position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); background:#fff; border:1px solid var(--muted); padding:2px 6px; border-radius:8px; font-size:.8rem}

  .cellWrap{position:relative}
  .cellBlock{
    position:absolute; width:var(--tileSize); height:var(--tileSize);
    box-sizing:border-box; border-radius:10px; border:2px solid var(--stroke);
  }
  .cellBlock .hole{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:36%; height:36%; border-radius:50%; background:#fff; opacity:.9;
  }

  .numchip{width:calc(var(--tileSize)*1.6); height:calc(var(--tileSize)*1.2); border-radius:12px; border:1px solid var(--muted); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1.2rem; color:#111}

  .mold{
    position:absolute; pointer-events:auto;
    border:2px dashed #7082a3; border-radius:12px; background:rgba(42,123,246,0.06)
  }
  .slot{position:absolute; width:var(--tileSize); height:var(--tileSize)}
  .slot::after{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:36%; height:36%; border-radius:50%; border:2px dashed #97a7c9; opacity:.7;
  }
  .moldFooter{
    position:absolute; left:0; top:100%; margin-top:4px;
    font-weight:800; background:#fff; border:1px solid var(--muted); border-radius:10px; padding:2px 8px
  }

  /* --- STAMPA SOLO TAVOLO --- */
  @media print{
    @page{ margin:10mm; }
    /* nasconde tutto tranne il tavolo */
    body.print-only-workspace header,
    body.print-only-workspace #tools,
    body.print-only-workspace #summary{ display:none !important; }

    body.print-only-workspace .wrap{
      grid-template-columns:1fr !important;
      padding:0 !important; gap:0 !important; height:auto !important;
    }
    body.print-only-workspace #workspace{
      border:none !important; border-radius:0 !important;
      overflow:visible !important; height:auto !important; page-break-inside:avoid;
    }
    /* elementi non utili in stampa */
    body.print-only-workspace .badge,
    body.print-only-workspace .rotBtn,
    body.print-only-workspace .labelNum,
    body.print-only-workspace .moldFooter{ display:none !important; }
  }
</style>
</head>
<body>
<header>
  <h1>Piastrelle numeriche – somma delle frazioni (fix)</h1>
  <p>Ogni sagoma mostra <strong>somma piastre interne / obiettivo</strong>. La colonna di destra mostra la <strong>somma delle frazioni</strong> su tutte le sagome.</p>
</header>

<div class="wrap">
  <section id="tools" class="panel">
    <div class="row">
      <span style="font-weight:600">Aggiungi come:</span>
      <div class="seg" role="radiogroup">
        <label><input type="radio" name="mode" value="plate" checked><span>Piastre</span></label>
        <label><input type="radio" name="mode" value="number"><span>Solo numeri</span></label>
      </div>
    </div>
    <div class="row">
      <label><input type="checkbox" id="toggleLabels" checked> Etichette</label>
      <label><input type="checkbox" id="toggleMagnet" checked> Magnetizza</label>
    </div>
    <div class="row">
      <span>Passo</span>
      <input type="range" id="cellSize" min="36" max="64" step="2" value="48">
      <span id="cellSizeVal">48</span> px
      <label for="target" style="margin-left:8px">Obiettivo</label>
      <input id="target" type="number" min="1" max="30" step="1" value="10">
      <button id="clear" class="danger">Cancella</button>
      <button id="print" class="ok">Stampa</button>
    </div>
    <hr style="margin:10px 0">
    <div class="row"><span style="font-weight:600">Serie (gruppi) di sagome</span></div>
    <div class="row">
      <label>n. sagome per nuova serie <input id="moldsPerGroup" type="number" min="1" max="8" step="1" value="3"></label>
      <button id="addGroup" class="ok">Aggiungi serie</button>
    </div>
    <hr style="margin:10px 0">
    <div id="palette"></div>
  </section>

  <main id="workspace" class="panel" aria-label="Tavolo di lavoro"></main>

  <aside id="summary" class="panel" aria-live="polite">
    <div>Somma frazioni: <strong id="fracSum">0</strong></div>
    <div id="fracDetail" style="margin-top:6px; font-size:.95rem; color:#333">—</div>
  </aside>
</div>

<script defer>
(function(){
  var COLORS={1:'var(--c1)',2:'var(--c2)',3:'var(--c3)',4:'var(--c4)',5:'var(--c5)',6:'var(--c6)',7:'var(--c7)',8:'var(--c8)',9:'var(--c9)',10:'var(--c10)'};
  var workspace=document.getElementById('workspace');
  var palette=document.getElementById('palette');
  var fracSumEl=document.getElementById('fracSum');
  var fracDetail=document.getElementById('fracDetail');
  var cellSizeInput=document.getElementById('cellSize');
  var cellSizeVal=document.getElementById('cellSizeVal');
  var targetInput=document.getElementById('target');
  var moldsPerGroupInput=document.getElementById('moldsPerGroup');
  var magnetToggle=document.getElementById('toggleMagnet');

  var cellSize=48, showLabels=true, addMode='plate', magnetOn=true, idCounter=1;
  var molds=[];

  function setCSSVar(n,v){ document.documentElement.style.setProperty(n,v); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function rowsFor(n){ return Math.ceil(n/2); }
  function baseCells(n){ var a=[]; for(var i=0;i<n;i++){ a.push({x:i%2, y:Math.floor(i/2)}); } return a; }
  function rotateCells(cells, rows, rot){
    var W=2, H=rows;
    function rot90(p){ return {x:p.y, y:(W-1)-p.x}; }
    function rot180(p){ return {x:(W-1)-p.x, y:(H-1)-p.y}; }
    function rot270(p){ return {x:(H-1)-p.y, y:p.x}; }
    var out=cells.map(p=>({x:p.x,y:p.y}));
    if(rot===90){ out=out.map(rot90); var t=W; W=H; H=t; }
    else if(rot===180){ out=out.map(rot180); }
    else if(rot===270){ out=out.map(rot270); var t2=W; W=H; H=t2; }
    var minX=Math.min.apply(null,out.map(p=>p.x)), minY=Math.min.apply(null,out.map(p=>p.y));
    out=out.map(p=>({x:p.x-minX, y:p.y-minY}));
    var maxX=Math.max.apply(null,out.map(p=>p.x)), maxY=Math.max.apply(null,out.map(p=>p.y));
    return {cells:out, w:maxX+1, h:maxY+1};
  }
  function geomFor(n, rot){ return rotateCells(baseCells(n), rowsFor(n), rot); }
  function getRot(el){ return parseInt(el.dataset.rot||'0',10); }
  function setGridPos(el,gx,gy,wcells,hcells){
    el.dataset.gx=String(gx); el.dataset.gy=String(gy);
    if(wcells && hcells){ el.style.width=(wcells*cellSize)+'px'; el.style.height=(hcells*cellSize)+'px'; }
    el.style.left=(gx*cellSize)+'px'; el.style.top=(gy*cellSize)+'px';
  }
  function getGridPos(el){ return {gx:parseInt(el.dataset.gx||'0',10), gy:parseInt(el.dataset.gy||'0',10)}; }

  function renderPlate(el){
    var n=parseInt(el.dataset.value,10), rot=getRot(el), g=geomFor(n,rot);
    el.dataset.wcells=String(g.w); el.dataset.hcells=String(g.h);
    var wrap=el.querySelector('.cellWrap'); wrap.innerHTML='';
    wrap.style.width=(g.w*cellSize)+'px'; wrap.style.height=(g.h*cellSize)+'px';
    g.cells.forEach(function(pos){
      var b=document.createElement('div'); b.className='cellBlock';
      b.style.left=(pos.x*cellSize)+'px'; b.style.top=(pos.y*cellSize)+'px';
      b.style.background=COLORS[n];
      var hole=document.createElement('div'); hole.className='hole'; b.appendChild(hole);
      wrap.appendChild(b);
    });
  }
  function createPlate(n){
    var el=document.createElement('div'); el.className='item plate'; el.tabIndex=0;
    el.dataset.value=String(n); el.dataset.rot='0'; el.dataset.id='it_'+(idCounter++);
    var wrap=document.createElement('div'); wrap.className='cellWrap';
    var badge=document.createElement('div'); badge.className='badge'; badge.textContent='×'; badge.title='Rimuovi';
    badge.onclick=function(e){ e.stopPropagation(); el.remove(); refreshSummary(); };
    var rot=document.createElement('div'); rot.className='rotBtn'; rot.title='Ruota (R)'; rot.textContent='↻';
    rot.onclick=function(e){ e.stopPropagation(); rotate(el,90); };
    var lbl=document.createElement('div'); lbl.className='labelNum'; lbl.textContent=n; lbl.style.display=showLabels?'block':'none';
    el.appendChild(badge); el.appendChild(rot); el.appendChild(lbl); el.appendChild(wrap);
    renderPlate(el);
    el.addEventListener('keydown', function(e){
      var gp=getGridPos(el), gx=gp.gx, gy=gp.gy;
      if(e.key==='ArrowLeft'){gx-=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowRight'){gx+=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowUp'){gy-=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowDown'){gy+=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='r'||e.key==='R'){ rotate(el,90); e.preventDefault(); return; }
      if(e.key==='Delete'){ el.remove(); refreshSummary(); return; }
    });
    return el;
  }
  function rotate(el, delta){
    var r=(getRot(el)+delta)%360; el.dataset.rot=String(r);
    renderPlate(el);
    var gp=getGridPos(el); setGridPos(el,gp.gx,gp.gy);
    if(magnetOn) magnetSnap(el);
    refreshSummary();
  }

  function buildPalette(){
    for(var n=1;n<=10;n++){
      var card=document.createElement('div'); card.className='pItem';
      var prev=document.createElement('div'); prev.className='numPreview'; prev.style.background=COLORS[n]; prev.textContent=n;
      var btn=document.createElement('button'); btn.className='act'; btn.textContent='Aggiungi '+n;
      btn.addEventListener('click', (function(k){ return function(){ var s=nextSpawn(); addPlate(k,s.gx,s.gy); }; })(n));
      card.appendChild(prev); card.appendChild(btn); palette.appendChild(card);
    }
  }
  buildPalette();

  function createSeries(count){
    var T = parseInt(targetInput.value||'0',10)||10;
    var rows = Math.ceil(T/2);
    var maxGX = 0;
    molds.forEach(function(m){ maxGX = Math.max(maxGX, m.gx + 2); });
    var startGX = (molds.length>0) ? maxGX + 1 : 2;
    var gy = 2;
    for(var i=0;i<count;i++){
      var gx = startGX + i*3;
      var moldEl=document.createElement('div'); moldEl.className='mold';
      moldEl.dataset.gx=String(gx); moldEl.dataset.gy=String(gy); moldEl.dataset.rows=String(rows);
      workspace.appendChild(moldEl);
      drawMold(moldEl, T, rows);
      var footer=document.createElement('div'); footer.className='moldFooter'; footer.textContent='0 / '+T;
      workspace.appendChild(footer);
      footer.style.left=(gx*cellSize)+'px';
      footer.style.top=((gy+rows)*cellSize+4)+'px';
      molds.push({el:moldEl, gx:gx, gy:gy, rows:rows, footerEl:footer});
    }
    refreshSummary();
  }

  function drawMold(moldEl, target, rows){
    var gx=parseInt(moldEl.dataset.gx,10), gy=parseInt(moldEl.dataset.gy,10);
    moldEl.style.left=(gx*cellSize)+'px';
    moldEl.style.top=(gy*cellSize)+'px';
    moldEl.style.width=(2*cellSize)+'px';  moldEl.style.height=(rows*cellSize)+'px';
    moldEl.querySelectorAll('.slot').forEach(s=>s.remove());
    for(var i=0;i<target;i++){
      var r=Math.floor(i/2), c=i%2;
      var slot=document.createElement('div'); slot.className='slot';
      slot.style.left=(c*cellSize)+'px'; slot.style.top=(r*cellSize)+'px';
      moldEl.appendChild(slot);
    }
  }

  document.getElementById('addGroup').addEventListener('click', function(){
    var m = clamp(parseInt(moldsPerGroupInput.value||'3',10),1,8);
    createSeries(m);
  });

  function geomAt(el){ var n=parseInt(el.dataset.value,10), rot=getRot(el); return geomFor(n,rot); }
  function plateCellsAbs(el){
    var gp=getGridPos(el), g=geomAt(el);
    return g.cells.map(function(p){ return {x:gp.gx+p.x, y:gp.gy+p.y}; });
  }

  function buildMoldOcc(mold, excludeId){
    // Accetta oggetto sagoma ({gx,gy,rows}) o elemento DOM con dataset.*
    var rows = mold.rows || parseInt(mold.dataset.rows,10);
    var gx   = mold.gx   || parseInt(mold.dataset.gx,10);
    var gy   = mold.gy   || parseInt(mold.dataset.gy,10);
    var occ=[new Array(rows).fill(false), new Array(rows).fill(false)];
    workspace.querySelectorAll('.plate').forEach(function(p){
      if(p.dataset.id===excludeId) return;
      plateCellsAbs(p).forEach(function(q){
        var rx=q.x-gx, ry=q.y-gy;
        if(rx>=0 && rx<2 && ry>=0 && ry<rows) occ[rx][ry]=true;
      });
    });
    return {occ:occ, gx:gx, gy:gy, rows:rows};
  }

  function canPlaceInMold(n, rot, relGY, offsetX, info){
    var g=geomFor(n,rot); if(g.w>2) return false;
    var maxTop=info.rows - g.h; if(relGY<0 || relGY>maxTop) return false;
    for(var i=0;i<g.cells.length;i++){
      var cx=offsetX + g.cells[i].x, cy=relGY + g.cells[i].y;
      if(cx<0 || cx>=2) return false;
      if(info.occ[cx][cy]) return false;
    }
    return true;
  }

  function bestPlacementFor(el){
    if(molds.length===0) return null;
    var gp=getGridPos(el), desiredGY=gp.gy;
    var moldsAll=molds.slice().sort(function(a,b){ return Math.abs(gp.gx - a.gx) - Math.abs(gp.gx - b.gx); });
    var n=parseInt(el.dataset.value,10), currentRot=getRot(el);
    var rotations=[currentRot, (currentRot+90)%360, (currentRot+180)%360, (currentRot+270)%360];
    for(var mi=0; mi<moldsAll.length; mi++){
      var info=buildMoldOcc(moldsAll[mi], el.dataset.id);
      var maxShift=info.rows;
      for(var ri=0; ri<rotations.length; ri++){
        var rot=rotations[ri];
        var g=geomFor(n,rot); if(g.w>2) continue;
        var candidates=[0, 1-(g.w-1)]; candidates=[...new Set(candidates)].filter(o=>o===0||o===1);
        var maxTop=info.rows - g.h;
        for(var d=0; d<=maxShift; d++){
          var tryGY=clamp(desiredGY - info.gy - d, 0, maxTop);
          for(var ci=0; ci<candidates.length; ci++){
            if(canPlaceInMold(n, rot, tryGY, candidates[ci], info)){
              return {gx: info.gx + candidates[ci], gy: info.gy + tryGY, rot: rot};
            }
          }
          tryGY=clamp(desiredGY - info.gy + d, 0, maxTop);
          for(var ci2=0; ci2<candidates.length; ci2++){
            if(canPlaceInMold(n, rot, tryGY, candidates[ci2], info)){
              return {gx: info.gx + candidates[ci2], gy: info.gy + tryGY, rot: rot};
            }
          }
          if((desiredGY - info.gy - d)<=0 && (desiredGY - info.gy + d)>=maxTop) break;
        }
      }
    }
    return null;
  }

  function magnetSnap(el){
    if(!magnetOn) return;
    var best=bestPlacementFor(el);
    if(best){
      el.dataset.rot=String(best.rot); renderPlate(el);
      setGridPos(el, best.gx, best.gy);
    }
  }

  function enableMove(el){
    var startX=0,startY=0,baseGX=0,baseGY=0,drag=false;
    function pt(ev){ return ev.touches && ev.touches[0] ? {x:ev.touches[0].clientX,y:ev.touches[0].clientY} : {x:ev.clientX,y:ev.clientY}; }
    function down(ev){
      ev.preventDefault(); el.classList.add('dragging');
      var p=pt(ev); startX=p.x; startY=p.y;
      var gp=getGridPos(el); baseGX=gp.gx; baseGY=gp.gy; drag=true;
      window.addEventListener('pointermove', move); window.addEventListener('pointerup', up, {once:true});
    }
    function move(ev){
      if(!drag) return; var p=pt(ev); var dx=p.x-startX, dy=p.y-startY;
      setGridPos(el, baseGX + Math.round(dx/cellSize), baseGY + Math.round(dy/cellSize));
    }
    function up(){
      drag=false; el.classList.remove('dragging');
      if(magnetOn) magnetSnap(el);
      refreshSummary();
      window.removeEventListener('pointermove', move);
    }
    el.addEventListener('pointerdown', down);
    el.addEventListener('keydown', function(e){
      var gp=getGridPos(el), gx=gp.gx, gy=gp.gy;
      if(e.key==='ArrowLeft'){gx-=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowRight'){gx+=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowUp'){gy-=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='ArrowDown'){gy+=1; setGridPos(el,gx,gy); e.preventDefault(); updateAfterMove(el); return;}
      if(e.key==='r' || e.key==='R'){ rotate(el,90); e.preventDefault(); return; }
      if(e.key==='Delete'){ el.remove(); refreshSummary(); return; }
    });
  }
  function updateAfterMove(el){
    if(magnetOn) magnetSnap(el);
    refreshSummary();
  }

  var spawnStep=0; function nextSpawn(){ spawnStep=(spawnStep+1)%6; return {gx:1+spawnStep, gy:1}; }
  function addPlate(n,gx,gy){ var el=createPlate(n); workspace.appendChild(el); setGridPos(el,gx,gy); enableMove(el); refreshSummary(); }

  function plateFullyInsideMold(moldAny, plateEl){
    // Accetta elemento DOM della sagoma o oggetto sagoma
    var moldEl = moldAny.el ? moldAny.el : moldAny;
    var gx=parseInt(moldEl.dataset.gx,10), gy=parseInt(moldEl.dataset.gy,10), rows=parseInt(moldEl.dataset.rows,10);
    var gp=getGridPos(plateEl), g=geomAt(plateEl);
    return g.cells.every(function(p){ var x=gp.gx+p.x, y=gp.gy+p.y; return (x>=gx && x<gx+2 && y>=gy && y<gy+rows); });
  }

  function refreshMoldFractionsAndTotal(){
    var T = parseInt(targetInput.value||'0',10)||10;
    var totalNumerator=0;
    molds.forEach(function(M){
      var sum=0;
      var plates=Array.from(workspace.querySelectorAll('.plate'));
      plates.forEach(function(p){ if(plateFullyInsideMold(M.el, p)) sum += parseInt(p.dataset.value,10); });
      totalNumerator += sum;
      M.footerEl.textContent = sum + ' / ' + T;
      M.footerEl.style.left=(M.gx*cellSize)+'px';
      M.footerEl.style.top=((M.gy+M.rows)*cellSize+4)+'px';
    });
    fracSumEl.textContent = totalNumerator + " / " + T;
    var asDecimal = (totalNumerator / T).toFixed(2);
    fracDetail.textContent = "Equivalente: " + asDecimal + " (somma dei numeratori / obiettivo)";
  }

  function refreshSummary(){ refreshMoldFractionsAndTotal(); }

  cellSizeInput.addEventListener('input', function(){
    cellSize=parseInt(cellSizeInput.value,10); cellSizeVal.textContent=cellSize; setCSSVar('--tileSize', cellSize+'px');
    var T = parseInt(targetInput.value||'0',10)||10;
    var rows = Math.ceil(T/2);
    molds.forEach(function(M){
      M.rows=rows; M.el.dataset.rows=String(rows);
      drawMold(M.el, T, rows);
    });
    // ricrea piastre preservando posizioni/rotazioni
    var plats=Array.from(workspace.querySelectorAll('.plate'));
    var snap=plats.map(function(p){ return { n:parseInt(p.dataset.value,10), gx:parseInt(p.dataset.gx||'0',10), gy:parseInt(p.dataset.gy||'0',10), rot:getRot(p) }; });
    plats.forEach(function(p){ p.remove(); });
    snap.forEach(function(s){ var el=createPlate(s.n); workspace.appendChild(el); el.dataset.rot=String(s.rot); renderPlate(el); setGridPos(el,s.gx,s.gy); enableMove(el); });
    refreshSummary();
  });
  targetInput.addEventListener('input', function(){
    var T = parseInt(targetInput.value||'0',10)||10;
    var rows = Math.ceil(T/2);
    molds.forEach(function(M){
      M.rows=rows; M.el.dataset.rows=String(rows);
      drawMold(M.el, T, rows);
    });
    refreshSummary();
  });

  document.getElementById('clear').addEventListener('click', function(){
    Array.from(workspace.querySelectorAll('.item')).forEach(function(el){el.remove();});
    refreshSummary();
  });

  /* ===== Stampa solo tavolo ===== */
  document.getElementById('print').addEventListener('click', function(){
    try{
      document.body.classList.add('print-only-workspace'); // attiva layout di stampa
      window.print();
    } finally {
      document.body.classList.remove('print-only-workspace'); // ripristina UI
    }
  });

  // Avvio
  createSeries(3);
})();
</script>
</body>
</html>
